doctype html
html(lang="zh-CN")
  head
    meta(charset="utf-8")
    meta(name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1,maximum-scale=2,viewport-fit=cover")
    meta(http-equiv="X-UA-Compatible" content="IE=edge,chrome=1")
    meta(name="renderer" content="webkit")
    
    //- SEOä¼˜åŒ–ï¼šå®Œå–„Metaæ ‡ç­¾
    title #{title} - JiangKingåšå®¢
    meta(name="description" content=`${summary || 'é˜…è¯»JiangKingåšå®¢ä¸Šçš„ã€Š'+title+'ã€‹ï¼Œæ¢ç´¢æ›´å¤šæŠ€æœ¯å†…å®¹'}`)
    meta(name="keywords" content=`${tags ? tags.join(',') : ''}, ${title}, åšå®¢, JiangKing`)
    meta(name="author" content=`${author || 'JiangKing'}`)
    
    //- ç¤¾äº¤åˆ†äº«Metaæ ‡ç­¾
    meta(property="og:title" content=`${title} - JiangKingåšå®¢`)
    meta(property="og:description" content=`${summary || 'é˜…è¯»JiangKingåšå®¢ä¸Šçš„ã€Š'+title+'ã€‹ï¼Œæ¢ç´¢æ›´å¤šæŠ€æœ¯å†…å®¹'}`)
    meta(property="og:type" content="article")
    meta(property="og:url" content=`${config && config.url ? config.url : 'https://jiangking.com'}/blog/${id}.html`)
    meta(property="article:published_time" content=`${date}`)
    meta(property="article:author" content=`${author || 'JiangKing'}`)
    if tags && tags.length
      each tag in tags
        meta(property="article:tag" content=tag)
    
    //- ç§»åŠ¨å‹å¥½ä¼˜åŒ–
    meta(name="theme-color" content="#0f0f23")
    meta(name="apple-mobile-web-app-capable" content="yes")
    meta(name="apple-mobile-web-app-status-bar-style" content="black-translucent")
    
    //- é¢„åŠ è½½å…³é”®èµ„æº
    link(rel="preload" href="/css/blog.css" as="style")
    
    link(rel="stylesheet" href="/css/blog.css")
    style.
      .image-container {
        margin: 20px 0;
        text-align: center;
        position: relative;
      }
      
      .image-container img {
        max-width: 100%;
        min-height: 150px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        loading: lazy; /* å»¶è¿ŸåŠ è½½ä¼˜åŒ– */
      }
      
      /* ç‰¹æ®Šæ ·å¼ç”¨äºSVGå›¾ç‰‡ */
      .image-container img.svg-image {
        background-color: #f8f9fa;
        padding: 10px;
        border: 1px solid #e2e8f0;
      }
      
      .image-container img.error {
        border: 1px dashed #ff5555;
        background-color: #ffecea;
      }
      
      /* ç§»åŠ¨ç«¯ä¼˜åŒ–æ ·å¼ */
      @media (max-width: 768px) {
        .article-header {
          padding: 60px 15px 30px;
        }
        
        .article-title {
          font-size: 1.8rem;
          line-height: 1.3;
        }
        
        .article-meta {
          flex-wrap: wrap;
          gap: 8px;
        }
        
        .article-container {
          padding: 20px 15px;
        }
      }
  body
    .dynamic-bg
    .grid-bg
    .cursor-glow#cursorGlow
    .progress-bar#progressBar
    
    //- å¢å¼ºè¯­ä¹‰åŒ–ï¼šä½¿ç”¨headeræ ‡ç­¾
    header.top-nav(role="banner")
      .nav-left
        a.back-btn(href="/blog/" title="è¿”å›é¦–é¡µ" aria-label="è¿”å›åšå®¢é¦–é¡µ") â†
        h3.site-title JiangKing
      .nav-right
        button.nav-btn(title="ç›®å½•" aria-label="æŸ¥çœ‹æ–‡ç« ç›®å½•") ğŸ“‘
        button.nav-btn(title="æš—è‰²æ¨¡å¼" aria-label="åˆ‡æ¢æš—è‰²æ¨¡å¼") ğŸŒ™
        button.nav-btn(title="åˆ†äº«" aria-label="åˆ†äº«æ–‡ç« ") ğŸ”—
        
    //- æ–‡ç« å¤´éƒ¨
    section.article-header
      .header-bg
        canvas#headerCanvas
      .header-content
        h1.article-title(itemprop="headline") #{title}
        .article-meta
          span.meta-item
            span.meta-icon ğŸ‘¤
            span(itemprop="author") #{author}
          span.meta-item
            span.meta-icon ğŸ“…
            time(itemprop="datePublished" datetime=date) #{date}
          span.meta-item
            span.meta-icon â±ï¸
            span 1 min read
          span.meta-item
            span.meta-icon ğŸ‘ï¸
            span 1.2k
            
    //- å¢å¼ºè¯­ä¹‰åŒ–ï¼šä½¿ç”¨articleæ ‡ç­¾
    article.article-container(itemscope itemtype="https://schema.org/BlogPosting")
      //- éšè—çš„å…ƒæ•°æ®
      meta(itemprop="headline" content=title)
      meta(itemprop="author" content=author)
      meta(itemprop="datePublished" content=date)
      if tags && tags.length
        each tag in tags
          meta(itemprop="keywords" content=tag)
          
      //- æ–‡ç« å†…å®¹
      .article-content(itemprop="articleBody")
        | !{content}
        
      //- æ–‡ç« æ ‡ç­¾
      section.article-tags(role="contentinfo" aria-label="æ–‡ç« æ ‡ç­¾")
        each tag in tags || []
          a.tag(href=`/blog/?tag=${tag}` rel="tag") #{tag}
          
      //- ä½œè€…ä¿¡æ¯
      section.author-info(itemscope itemtype="https://schema.org/Person")
        .author-avatar
          img(src="/assets/avatar.jpg" alt=author itemprop="image" loading="lazy")
        .author-details
          h4(itemprop="name") #{author}
          p.author-bio(itemprop="description") STDIN | Think >> /dev/Mindâœ¨ - ä¸“æ³¨äºæŠ€æœ¯åˆ†äº«ä¸æ€è€ƒ
          
      //- ç›¸å…³æ–‡ç« 
      section.related-posts(aria-labelledby="related-posts-title")
        h3.section-title#related-posts-title ç›¸å…³æ–‡ç« 
        .related-grid(role="feed" aria-label="ç›¸å…³æ–‡ç« åˆ—è¡¨")
          //- ç›¸å…³æ–‡ç« å†…å®¹
          
    //- æ–‡ç« åº•éƒ¨æ“ä½œæ 
    div.article-actions(role="toolbar" aria-label="æ–‡ç« æ“ä½œ")
      button.action-btn(title="ç‚¹èµ" aria-label="ç‚¹èµæ–‡ç« ") ğŸ‘
      button.action-btn(title="æ”¶è—" aria-label="æ”¶è—æ–‡ç« ") â­
      button.action-btn(title="è¯„è®º" aria-label="æŸ¥çœ‹æˆ–å‘è¡¨è¯„è®º") ğŸ’¬
      .action-divider
      button.action-btn(title="åˆ†äº«" aria-label="åˆ†äº«æ–‡ç« ") ğŸ“¤
      button.action-btn(title="å›åˆ°é¡¶éƒ¨" onclick="scrollToTop()" aria-label="å›åˆ°é¡µé¢é¡¶éƒ¨") â¬†ï¸
      
    //- ç›®å½•å¯¼èˆª
    nav.toc#toc(role="navigation" aria-label="æ–‡ç« ç›®å½•")
      h4.toc-title ç›®å½•
      ul.toc-list
        //- ç›®å½•å†…å®¹
        
    //- æ·»åŠ ç»“æ„åŒ–æ•°æ®
    script(type="application/ld+json").
      {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "headline": "#{title}",
        "datePublished": "#{date}",
        "dateModified": "#{modifiedDate || date}",
        "author": {
          "@type": "Person",
          "name": "#{author || 'JiangKing'}"
        },
        "publisher": {
          "@type": "Organization",
          "name": "JiangKingåšå®¢",
          "logo": {
            "@type": "ImageObject",
            "url": "https://jiangking.com/assets/avatar.jpg"
          }
        },
        "description": "#{summary || 'é˜…è¯»JiangKingåšå®¢ä¸Šçš„ã€Š'+title+'ã€‹ï¼Œæ¢ç´¢æ›´å¤šæŠ€æœ¯å†…å®¹'}",
        "mainEntityOfPage": {
          "@type": "WebPage",
          "@id": "#{config && config.url ? config.url : 'https://jiangking.com'}/blog/#{id}.html"
        }
      }

    script.
      // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
      document.addEventListener('DOMContentLoaded', function() {
        console.log('å¼€å§‹å¤„ç†å›¾ç‰‡æ˜¾ç¤ºé—®é¢˜');
        
        // æ£€æµ‹æµè§ˆå™¨æ˜¯å¦æ”¯æŒwebpæ ¼å¼
        function checkWebpSupport() {
          const canvas = document.createElement('canvas');
          if (!canvas.getContext || !canvas.getContext('2d')) {
            return false;
          }
          
          return canvas.toDataURL('image/webp').indexOf('data:image/webp') === 0;
        }
        
        const supportsWebp = checkWebpSupport();
        console.log('æµè§ˆå™¨æ”¯æŒwebpæ ¼å¼:', supportsWebp);

        // 1. å¤„ç†ç›´æ¥æ˜¾ç¤ºä¸ºæ–‡æœ¬çš„å›¾ç‰‡URL (657bf33bfbf478066fd24f11b0eb95f7.webp)
        const allElements = document.querySelectorAll('.article-content *');
        allElements.forEach(el => {
          // æ£€æŸ¥æ˜¯å¦ä¸ºçº¯æ–‡æœ¬å…ƒç´ ä¸”æ–‡æœ¬å†…å®¹åƒå›¾ç‰‡URL
          const content = el.textContent ? el.textContent.trim() : '';
          if (content && (
              content.match(/[a-f0-9]{32}\.webp$/i) ||
              content.match(/\.(webp|jpg|png|gif|jpeg)$/i)
            ) &&
            el.childNodes.length === 1 &&
            el.childNodes[0].nodeType === Node.TEXT_NODE) {
            
            console.log('æ‰¾åˆ°å¯èƒ½æ˜¯å›¾ç‰‡URLçš„æ–‡æœ¬:', content);
            
            // åˆ›å»ºå›¾ç‰‡å®¹å™¨å’Œå›¾ç‰‡å…ƒç´ 
            const imgContainer = document.createElement('div');
            imgContainer.className = 'image-container';
            
            const img = document.createElement('img');
            
            // å°è¯•æ„é€ æ­£ç¡®çš„å›¾ç‰‡è·¯å¾„
            if (content.startsWith('/')) {
              // å·²ç»æ˜¯ç›¸å¯¹è·¯å¾„
              img.src = content;
            } else if (content.match(/[a-f0-9]{32}\.webp$/i) || content.endsWith('.webp')) {
              // çœ‹èµ·æ¥åƒæ˜¯åœ¨å½“å‰æ–‡ç« ç›®å½•ä¸‹çš„webpå›¾ç‰‡
              const articleId = window.location.pathname.split('/').pop().replace('.html', '');
              img.src = `/blog/images/${articleId}/${content}`;
            } else {
              // é»˜è®¤ä½¿ç”¨å ä½å›¾
              img.src = '/assets/placeholder-image.svg';
            }
            
            // æ·»åŠ é”™è¯¯å¤„ç†
            img.alt = 'æ–‡ç« å›¾ç‰‡';
            img.setAttribute('data-original-text', content);
            img.onerror = function() {
              this.onerror = null;
              this.src = '/assets/placeholder-image.svg';
              this.classList.add('error');
            };
            
            imgContainer.appendChild(img);
            
            // æ›¿æ¢å…ƒç´ 
            el.parentNode.replaceChild(imgContainer, el);
          }
        });
        
        // 2. æ£€æŸ¥å›¾ç‰‡å®¹å™¨å†…å®¹
        const imageContainers = document.querySelectorAll('.image-container');
        console.log('æ‰¾åˆ°å›¾ç‰‡å®¹å™¨:', imageContainers.length);
        
        imageContainers.forEach((container) => {
          // æ£€æŸ¥å®¹å™¨æ˜¯å¦åªæœ‰æ–‡æœ¬å†…å®¹
          if (!container.querySelector('img') && container.textContent.trim()) {
            const content = container.textContent.trim();
            console.log('å›¾ç‰‡å®¹å™¨å†…åªæœ‰æ–‡æœ¬:', content);
            
            // æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';
            
            // åˆ›å»ºå›¾ç‰‡å…ƒç´ 
            const img = document.createElement('img');
            
            // å°è¯•æ„é€ æ­£ç¡®çš„å›¾ç‰‡è·¯å¾„
            if (content.match(/[a-f0-9]{32}\.webp$/i) || content.endsWith('.webp')) {
              // webpå›¾ç‰‡
              const articleId = window.location.pathname.split('/').pop().replace('.html', '');
              img.src = `/blog/images/${articleId}/${content}`;
            } else {
              // ä½¿ç”¨å ä½å›¾
              img.src = '/assets/placeholder-image.svg';
            }
            
            // æ·»åŠ é”™è¯¯å¤„ç†
            img.alt = 'æ–‡ç« å›¾ç‰‡';
            img.setAttribute('data-text-content', content);
            img.onerror = function() {
              this.onerror = null;
              this.src = '/assets/placeholder-image.svg';
              this.classList.add('error');
            };
            
            // æ·»åŠ åˆ°å®¹å™¨
            container.appendChild(img);
          }
        });
        
        // 3. å¤„ç†æ‰€æœ‰å›¾ç‰‡åŠ è½½é”™è¯¯
        const images = document.querySelectorAll('img');
        console.log('æ‰¾åˆ°å›¾ç‰‡å…ƒç´ :', images.length);
        
        images.forEach((img) => {
          // æ£€æŸ¥æ˜¯å¦ä¸ºSVGå›¾ç‰‡
          if (img.src.toLowerCase().endsWith('.svg')) {
            console.log('æ£€æµ‹åˆ°SVGå›¾ç‰‡:', img.src);
            img.classList.add('svg-image');
            // SVGå›¾ç‰‡ä¸éœ€è¦é”™è¯¯å¤„ç†
            return;
          }
          
          if (img.complete && img.naturalHeight === 0) {
            // å·²ç»åŠ è½½å¤±è´¥çš„å›¾ç‰‡
            console.log('å›¾ç‰‡å·²åŠ è½½å¤±è´¥:', img.src);
            img.classList.add('error');
            
            // å¦‚æœä¸æ˜¯å ä½å›¾ï¼Œåˆ™æ›¿æ¢ä¸ºå ä½å›¾
            if (!img.src.includes('placeholder-image')) {
              img.setAttribute('data-failed-src', img.src);
              img.src = '/assets/placeholder-image.svg';
              img.classList.add('svg-image'); // æ·»åŠ SVGç±»
            }
          } else {
            // æ·»åŠ åŠ è½½é”™è¯¯å¤„ç†
            img.addEventListener('error', function() {
              console.log('å›¾ç‰‡åŠ è½½å¤±è´¥:', this.src);
              this.classList.add('error');
              
              // å¦‚æœä¸æ˜¯å ä½å›¾ï¼Œåˆ™æ›¿æ¢ä¸ºå ä½å›¾
              if (!this.src.includes('placeholder-image')) {
                this.setAttribute('data-failed-src', this.src);
                this.src = '/assets/placeholder-image.svg';
                this.classList.add('svg-image'); // æ·»åŠ SVGç±»
              }
            });
          }
        });
      });

      // æ»šåŠ¨åˆ°é¡¶éƒ¨
      function scrollToTop() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }